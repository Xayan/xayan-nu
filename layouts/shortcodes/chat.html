{{/* Shortcode: chat.html */}}
{{ $assistantName := .Get "assistant" | default "Assistant" }}
{{ $userName := .Get "user" | default "User" }}

<div class="chat">
  {{/* Split text into blocks, each starting with 'user:' or 'assistant:' */}}
  {{ $blocks := findRE `(?m)^(user|assistant):[\s\S]*?(.+)` .Inner }}
  {{ range $blocks }}
    {{ $line := . }}
    {{ $parts := findRE `(?m)^(user|assistant):(.*)` $line }}
    {{ if gt (len $parts) 0 }}
      {{ $role := lower (replaceRE `(?m)^(user|assistant):.*` "${1}" $line) }}
      {{ $displayName := cond (eq $role "assistant") $assistantName $userName }}
      {{ $msg := replaceRE `(?m)^(user|assistant):` "" $line }}
      {{ $msg = replace $msg "\\n" "\n" }}
      {{ $msg = markdownify $msg }}
      {{ if eq (len (findRE "<p[^>]*>" $msg)) 0 }}
        {{ $msg = printf "<p>%s</p>" $msg | safeHTML }}
      {{ end }}
      {{/* Render the message block */}}
      <div class="message {{ $role }}">
        <!--<div class="name">{{ $displayName }}</div>-->
        <div class="content">{{ $msg }}</div>
      </div>
      <div class="clear"></div>
    {{ end }}
  {{ end }}
</div>
